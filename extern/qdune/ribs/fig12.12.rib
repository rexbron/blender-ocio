#########################################################################
# fig12.12.rib - RIB to create Figure 12.12 of:
#
# _Advanced RenderMan: Creating CGI for Motion Picture_, 
# by Anthony A. Apodaca and Larry Gritz, Morgan Kaufmann, 1999.
#
# This file demostrates the smoke shader.
# The lights in this file use a shadow map, which can be generated 
# by rendering smokesm before rendering this file.
#########################################################################

#----------------------------------------------
# shadowmap
Hider "hidden" "jitter" [0]
FrameBegin 1
Display "smokeball.sm" "zfile" "z"
Format 512 512 1
PixelSamples 1 1
PixelFilter "box" 1 1
ShadingRate 4
Projection "perspective" "fov" [25]
ConcatTransform [-1 0 0 0 0 1 0 0 0 0 -1 0 0 0 0 1]
Translate 0 0 -8 
Attribute "dice" "binary" [1]
WorldBegin

AttributeBegin
Translate 0 0 2
Rotate -10 1 1 1
Sphere 1 -1 1 360
AttributeEnd

WorldEnd
FrameEnd

#----------------------------------------------
# image

Hider "hidden" "jitter" [1]
FrameBegin 2
#Option "searchpath" "shader" ["../shaders:&"]
Display "fig12.12" "framebuffer" "rgb"
#Display "fig12.12.tga" "file" "rgb"
Format 512 512 1
PixelSamples 4 4
Exposure 1 1.8
ShadingRate 1
Projection "perspective" "fov" [45]
Translate 0 0 7.5
Rotate -90 1 0 0
Translate 0 0 -2
Rotate -10 1 0 0
WorldBegin

AttributeBegin
Translate 0 0 8
Rotate 180 1 0 0
LightSource "uberlight" 1 "string lighttype" ["spot"]
"float falloff" [2] "intensity" [50] "float width" [.25] "float height" [.14] 
"string shadowmap" ["smokeball.sm"] "float shadowbias" [.1]
"color shadowcolor" [0.5 0.25 0.125]
"float shadowblur" [25]
AttributeEnd
Illuminate 1 1

Sides 1

Declare "stepsize" "float" 
Atmosphere "smoke" "stepsize" [.25]
	"float smokeoctaves" [8] "float smokefreq" [1] "float opacdensity" [0.025] 
	"float lightdensity" [0.075]

AttributeBegin
AttributeBegin
TransformBegin
Rotate 90 0 0 1
Scale .35 .35 .35
Surface "oakplank" "float Kr" [0]
TransformEnd
Patch "bilinear" "P"  [ -5 -5 0 5 -5 0  -5 5 0 5 5 0 ] 
AttributeEnd
Surface "matte"
Polygon "P"  [ -5 -5 0 -5 -5 10 5 -5 10 5 -5 0  ] 
Polygon "P"  [ 5 -5 0 5 -5 10 5 5 10 5 5 0  ] 
Polygon "P"  [ -5 5 0 -5 5 10 -5 -5 10 -5 -5 0  ] 
AttributeEnd

AttributeBegin
Sides 2
Translate 0 0 2
Rotate -10 1 1 1
Surface "starball"
Sphere 1 -1 1 360
AttributeEnd

WorldEnd
FrameEnd