# Original source:
# displacement
# dented ( float Km = 1; float power = 3; float frequency = 1; float maxoctaves = 6; )
# {
#   float magnitude = 0;
#   point PP = transform ("shader", P);
#   float size = frequency;
#   float i;
#   for (i = 0;  i < maxoctaves;  i += 1) {
#       magnitude += abs (.5 - noise (PP*size)) / size;
#       size *= 2;
#     }
#   P = P - (Km * pow (magnitude, power)) * normalize (N);
#   N = calculatenormal (P);
# }
displacement dented
param uniform float Km 1
param uniform float power 3
param uniform float frequency 1
param uniform float maxoctaves 6
temp float size
temp float magnitude
temp uniform float i
temp point PP
temp point $2
temp float $3
temp normal $4
global P N
codesegment @1
	# not in org.code, but negative powers will cause havoc, so make sure that doesn't happen
	abs					power power
@1
	movff				magnitude 0
	ptransform1	PP "shader" P
	movff				size frequency
	movff				i 0
@2
	mulvvf			$2 PP size
	noise3f			$3 $2
	subfff			$3 0.5 $3
	abs					$3 $3
	divfff			$3 $3 size
	addfff			magnitude magnitude $3
	mulfff			size size 2
	addfff			i i 1
	jltff				i maxoctaves @2
	pow					$3 magnitude power
	mulfff			$3 $3 Km
	normalize		$4 N
	msubvvf			P $4 $3
	calcnormal	N P
	return
