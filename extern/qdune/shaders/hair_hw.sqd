# Original source:
#surface hair (float Ka = 1, Kd = .6, Ks = .35, roughness = .15;
#              color rootcolor = color (.109, .037, .007);
#              color tipcolor = color (.519, .325, .125);
#              color specularcolor = (color(1) + tipcolor) / 2;
#             )
#{
#    vector T = normalize (dPdv); /* tangent along length of hair */
#    vector V = -normalize(I);    /* V is the view vector */
#    color Cspec = 0, Cdiff = 0;  /* collect specular & diffuse light */
#    float cosang;
#    /* Loop over lights, catch highlights as if this was a thin cylinder */
#    illuminance (P) {
#        cosang = cos (abs (acos (T.normalize(L)) - acos (-T.V)));
#        Cspec += Cl * v * pow (cosang, 1/roughness);
#        Cdiff += Cl * v;
#        /* We multipled by v to make it darker at the roots.  This
#         * assumes v=0 at the root, v=1 at the tip.
#         */
#    }
#    Oi = Os;
#    Ci = Oi * (mix(rootcolor, tipcolor, v) * (Ka*ambient() + Kd*Cdiff) + (Ks * Cspec * specularcolor));
#}
surface hair
param uniform float Ka	1
param uniform float Kd	0.6
param uniform float Ks	0.35
param uniform float roughness	0.15
param uniform color rootcolor .109 .037 .007
param uniform color tipcolor .519 .325 .125
param uniform color specularcolor 0 0 0
global P v dPdv I Oi Os Ci L Cl
temp vector T
temp vector V
temp color Cspec
temp color Cdiff
temp float cosang
const color $1 1 1 1
temp vector $2
temp float $3
temp float $4
temp uniform float $5
const float $6 1
temp color $7
temp float $8
temp color $9
codesegment @1
	addvvv		specularcolor $1 tipcolor
	mulvvf		specularcolor specularcolor 0.5
@1
	normalize	T dPdv
	normalize	V I
	negvv		V V
	movvf		Cspec 0
	movvf		Cdiff 0
	# $4 = acos (-T.V)
	vdot		$4 T V
	negff		$4 $4
	acos		$4 $4
	# $5 = 1/roughness
	divfff		$5 $6 roughness
@2
	illuminance1	P @3
	normalize	$2 L
	vdot		$3 T $2
	acos		$3 $3
	subfff		$3 $3 $4
	abs		$3 $3
	cos		cosang $3
	pow		$8 cosang $5
	mulfff		$8 $8 v
	maddvvf		Cspec Cl $8
	maddvvf		Cdiff Cl v
	jmp		@2
@3
	movvv			Oi Os
	mixv			$7 rootcolor tipcolor v
	ambient		$9
	mulvvf		$9 $9 Ka
	maddvvf		$9 Cdiff Kd
	mulvvv		$7 $7 $9
	mulvvv		$9 Cspec specularcolor
	mulvvf		$9 $9 Ks
	addvvv		$7 $7 $9
	mulvvv		Ci $7 Oi
	return
