# diffuse() emulate with illuminance loop
surface matte
param uniform float Ka 1
param uniform float Kd 1
global P N I Ci Cs Oi Os L Cl
temp vector $1
temp vector $2
const float hpi 1.5707963268
temp float $3
temp vector $4
codesegment
	normalize    $1 N
	faceforward  $1 $1 I
	movvf        $4 0
@1
	illuminance2 P $1 hpi @2
	normalize    $2 L
	vdot         $3 $1 $2
	maddvvf      $4 Cl $3
	jmp          @1
@2
	mulvvf       $1 $4 Kd
	ambient      $2
	mulvvf       $2 $2 Ka
	addvvv       $1 $1 $2
	mulvvv       Ci Cs $1
	movvv        Oi Os
	mulvvv       Ci Ci Oi
	return
