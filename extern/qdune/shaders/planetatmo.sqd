# QDSLC version 0.0.1-alpha
volume planetatmo
param uniform float density 60
param uniform float maxstepsize 2.5
param uniform float integend 100
param uniform float integstart 0
param uniform float use_lighting 1
param uniform float falloff 400
param uniform float atmos_type 0
param uniform float debug 0
param uniform float rbound 1.05
param uniform float k 50
param uniform float minstepsize 0.01
temp varying point PW_2
temp varying float len_3
temp varying point PW_1
temp varying vector incident
temp varying float te
temp varying color li
temp varying float len_1
temp varying color dC
temp varying point PP
temp varying float len_2
temp varying color lighttau
temp varying float tau
temp varying point origin
temp varying float t_1
temp varying float tc
temp varying color Ov
temp varying color Cv
temp varying vector IN
temp varying color dO
temp varying point PW_3
temp varying float last_dtau
temp varying float len
temp varying float minrad
temp varying color last_li
temp varying float dtau
temp varying float ss
temp varying float nsteps
temp varying point PW
temp varying float $1
temp varying float $2
temp uniform vector $3
temp varying vector $4
temp varying vector $5
temp uniform vector $6
temp varying vector $7
temp varying vector $8
temp varying vector $9
temp varying vector $10
temp varying vector $11
temp varying vector $12
temp varying vector $13
temp varying vector $14
temp varying vector $15
temp uniform vector $16
temp uniform vector $17
temp uniform float $18
temp varying float $19
temp varying vector $20
temp varying float $21
temp uniform float $22
temp varying float $23
temp varying float $24
temp varying float $25
temp varying float $26
temp varying float $27
temp varying float $28
temp varying float $29
temp varying float $30
temp varying float $31
temp uniform float $32
temp varying float $33
temp varying float $34
temp varying float $35
temp varying bool $36
temp varying bool $37
temp varying bool $38
temp uniform float $39
temp varying bool $40
temp varying bool $41
temp varying bool $42
temp varying bool $43
temp varying bool $44
temp uniform vector $45
const float $46 0
const float $47 1
const float $48 0.0005
const float $49 0.999
const string $50 "shader"
const float $51 0.5
const string $52 "nsteps = %f, tc = %f, t1 = %f, te = %f\n"
const float $53 0.001
const float $54 0.0001
const float $55 15
const string $56 "current"
const float $57 21
const string $58 "   Cv = %c, Ov = %c\n"
const float $59 2.25
global I P Ci Oi Cl
codesegment
	subvvv           $9 P I
	ptransform1      origin $50 $9
	vtransform1      incident $50 I
	normalize        IN incident
	movvf            Cv $46
	movvf            Ov $46
	movff            nsteps $46
	length           $27 incident
	minf             $27 $27 integend
	subfff           te $27 $54
	jneff            atmos_type $46 @1
	vdot             $27 origin IN
	negff            $27 $27
	clampf           tc $27 integstart te
	mulvvf           $9 IN tc
	addvvv           $9 origin $9
	length           minrad $9
	jmp              @2
@1
	movff            tc integstart
	movff            minrad $46
@2
	movff            t_1 tc
	ifltff           $38 t_1 te
	andltff          $38 minrad rbound
	cond_push        $38
	mulvvf           $9 IN t_1
	addvvv           PP origin $9
	movvf            li $46
	jneff            atmos_type $46 @3
	length           len PP
	ifltff           $36 len $47
	cond_push        $36
	movff            dtau $46
	cond_else
	negff            $18 falloff
	subfff           $26 len $49
	mulfff           $25 $18 $26
	exp              $25 $25
	mulfff           dtau density $25
	cond_pop
	jmp              @4
@3
	jneff            atmos_type $47 @5
	negff            $18 falloff
	zcomp            $26 PP
	mulfff           $25 $18 $26
	exp              $25 $25
	mulfff           dtau density $25
	jmp              @6
@5
	movff            dtau density
@6
@4
	jleff            use_lighting $46 @7
	ptransform2      PW $50 $56 PP
@9
	illuminance1     PW @10
	addvvv           li li Cl
	jmp              @9
@10
	jmp              @8
@7
	movvf            li $47
@8
	randomf          $26
	subfff           $23 te t_1
	mulfff           $24 k dtau
	addfff           $24 $24 $53
	divfff           $24 $47 $24
	clampf           $24 $24 minstepsize maxstepsize
	minf             $23 $24 $23
	mulfff           ss $26 $23
	addfff           t_1 t_1 ss
	addfff           nsteps nsteps $47
@11
	ifleff           $37 t_1 te
	cjmpnot          $37 @12
	cond_push        $37
	movff            last_dtau dtau
	movvv            last_li li
	mulvvf           $8 IN t_1
	addvvv           PP origin $8
	movvf            li $46
	jneff            atmos_type $46 @13
	length           len_1 PP
	ifltff           $40 len_1 $47
	cond_push        $40
	movff            dtau $46
	cond_else
	negff            $22 falloff
	subfff           $24 len_1 $49
	mulfff           $23 $22 $24
	exp              $23 $23
	mulfff           dtau density $23
	cond_pop
	jmp              @14
@13
	jneff            atmos_type $47 @15
	negff            $22 falloff
	zcomp            $24 PP
	mulfff           $23 $22 $24
	exp              $23 $23
	mulfff           dtau density $23
	jmp              @16
@15
	movff            dtau density
@16
@14
	jleff            use_lighting $46 @17
	ptransform2      PW_1 $50 $56 PP
@19
	illuminance1     PW_1 @20
	addvvv           li li Cl
	jmp              @19
@20
	jmp              @18
@17
	movvf            li $47
@18
	mulfff           $24 $51 ss
	addfff           $21 dtau last_dtau
	mulfff           tau $24 $21
	mulfff           $24 $51 ss
	mulvvf           $4 li dtau
	mulvvf           $5 last_li last_dtau
	addvvv           $4 $4 $5
	mulvvf           lighttau $4 $24
	negff            $24 tau
	exp              $24 $24
	negff            $21 tau
	mulfff           $21 $21 $59
	exp              $21 $21
	negff            $2 tau
	mulfff           $2 $2 $57
	exp              $2 $2
	movvf3           $7 $24 $21 $2
	movvf            $45 $47
	subvvv           dO $45 $7
	mulvvv           dC lighttau dO
	movvf            $45 $47
	subvvv           $5 $45 Ov
	maddvvv          Cv $5 dC
	movvf            $6 $47
	subvvv           $15 $6 Ov
	maddvvv          Ov $15 dO
	subfff           $34 te t_1
	mulfff           $35 k dtau
	addfff           $35 $35 $53
	divfff           $35 $47 $35
	clampf           $35 $35 minstepsize maxstepsize
	minf             $34 $35 $34
	maxf             ss $34 $48
	addfff           t_1 t_1 ss
	addfff           nsteps nsteps $47
	cond_pop
	jmp              @11
@12
	cond_pop
	movff            t_1 tc
	ifgtff           $43 t_1 integstart
	andltff          $43 minrad rbound
	cond_push        $43
	mulvvf           $15 IN t_1
	addvvv           PP origin $15
	movvf            li $46
	jneff            atmos_type $46 @21
	length           len_2 PP
	ifltff           $44 len_2 $47
	cond_push        $44
	movff            dtau $46
	cond_else
	negff            $32 falloff
	subfff           $29 len_2 $49
	mulfff           $35 $32 $29
	exp              $35 $35
	mulfff           dtau density $35
	cond_pop
	jmp              @22
@21
	jneff            atmos_type $47 @23
	negff            $32 falloff
	zcomp            $29 PP
	mulfff           $35 $32 $29
	exp              $35 $35
	mulfff           dtau density $35
	jmp              @24
@23
	movff            dtau density
@24
@22
	jleff            use_lighting $46 @25
	ptransform2      PW_2 $50 $56 PP
@27
	illuminance1     PW_2 @28
	addvvv           li li Cl
	jmp              @27
@28
	jmp              @26
@25
	movvf            li $47
@26
	randomf          $29
	subfff           $33 t_1 integstart
	mulfff           $30 k dtau
	addfff           $30 $30 $53
	divfff           $30 $47 $30
	clampf           $30 $30 minstepsize maxstepsize
	minf             $33 $30 $33
	mulfff           ss $29 $33
	subfff           t_1 t_1 ss
	addfff           nsteps nsteps $47
@29
	ifgeff           $41 t_1 integstart
	cjmpnot          $41 @30
	cond_push        $41
	movff            last_dtau dtau
	movvv            last_li li
	mulvvf           $14 IN t_1
	addvvv           PP origin $14
	movvf            li $46
	jneff            atmos_type $46 @31
	length           len_3 PP
	ifltff           $42 len_3 $47
	cond_push        $42
	movff            dtau $46
	cond_else
	negff            $39 falloff
	subfff           $30 len_3 $49
	mulfff           $33 $39 $30
	exp              $33 $33
	mulfff           dtau density $33
	cond_pop
	jmp              @32
@31
	jneff            atmos_type $47 @33
	negff            $39 falloff
	zcomp            $30 PP
	mulfff           $33 $39 $30
	exp              $33 $33
	mulfff           dtau density $33
	jmp              @34
@33
	movff            dtau density
@34
@32
	jleff            use_lighting $46 @35
	ptransform2      PW_3 $50 $56 PP
@37
	illuminance1     PW_3 @38
	addvvv           li li Cl
	jmp              @37
@38
	jmp              @36
@35
	movvf            li $47
@36
	mulfff           $30 $51 ss
	addfff           $31 dtau last_dtau
	mulfff           tau $30 $31
	mulfff           $30 $51 ss
	mulvvf           $13 li dtau
	mulvvf           $10 last_li last_dtau
	addvvv           $13 $13 $10
	mulvvf           lighttau $13 $30
	negff            $30 tau
	exp              $30 $30
	negff            $31 tau
	mulfff           $31 $31 $59
	exp              $31 $31
	negff            $28 tau
	mulfff           $28 $28 $57
	exp              $28 $28
	movvf3           $12 $30 $31 $28
	movvf            $3 $47
	subvvv           dO $3 $12
	mulvvv           dC lighttau dO
	movvf            $3 $47
	subvvv           $10 $3 dO
	mulvvv           $10 $10 Cv
	addvvv           Cv dC $10
	movvf            $17 $47
	subvvv           $11 $17 dO
	mulvvv           $11 $11 Ov
	addvvv           Ov dO $11
	subfff           $19 t_1 integstart
	mulfff           $1 k dtau
	addfff           $1 $1 $53
	divfff           $1 $47 $1
	clampf           $1 $1 minstepsize maxstepsize
	minf             $19 $1 $19
	maxf             ss $19 $48
	subfff           t_1 t_1 ss
	addfff           nsteps nsteps $47
	cond_pop
	jmp              @29
@30
	cond_pop
	mulvvf           $11 Cv $55
	movvf            $16 $47
	subvvv           $20 $16 Ov
	mulvvv           $20 $20 Ci
	addvvv           Ci $11 $20
	movvf            $16 $47
	subvvv           $20 $16 Ov
	mulvvv           $20 $20 Oi
	addvvv           Oi Ov $20
	jleff            debug $46 @39
	printf           $52 nsteps tc integstart te
	printf           $58 Cv Ov
@39
	return
