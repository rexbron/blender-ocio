# QDSLC version 0.0.1-alpha
light platlight
param uniform color lightcolor 1 1 1
param uniform point from 0.0 0.0 0.0
param uniform float density 2
param uniform float maxstepsize 2.5
param uniform float integend 100
param uniform float integstart 0
param uniform float falloff 400
param uniform float atmos_type 0
param uniform point to 0.0 0.0 0.0
param uniform float intensity 1
param uniform float debug 0
param uniform float rbound 10.5
param uniform float k 1
param uniform float minstepsize 0.01
temp varying point PP
temp varying float tc
temp varying color Ov
temp varying vector IN
temp varying color dO
temp varying float last_dtau
temp varying float tau
temp varying vector incident
temp varying float te
temp varying point origin
temp varying float t_1
temp varying float ss
temp varying float nsteps
temp varying float dtau
temp varying float minrad
temp varying vector $1
temp uniform vector $2
temp uniform vector $3
temp varying vector $4
temp varying vector $5
temp varying vector $6
temp uniform vector $7
temp varying float $8
temp varying float $9
temp varying float $10
temp varying float $11
temp uniform float $12
temp varying float $13
temp uniform float $14
temp varying float $15
temp varying bool $16
temp varying bool $17
temp varying vector $18
temp uniform vector $19
temp uniform vector $20
const float $21 0
const vector $22 0 0 1
const float $23 0.0005
const float $24 0.999
const string $25 "shader"
const float $26 0.5
const float $27 1
const float $28 0.001
const string $29 "origin = %p, incident = %p\n"
const vector $30 0 0 0
const string $31 "nsteps = %f, tc = %f, t1 = %f, te = %f, Ov = %c\n"
const float $32 21
const float $33 2.25
global Ps L Cl
codesegment @1
	ptocurr          from $25 $30
	ptocurr          to $25 $22
@1
	movvf            Ov $21
	movff            nsteps $21
	subvvv           $20 to from
	solar2           $20 $21
	movff            te integend
	vtransform1      incident $25 L
	normalize        IN incident
	ptransform1      $1 $25 Ps
	mulvvf           $5 IN te
	subvvv           origin $1 $5
	jleff            debug $21 @2
	mulvvf           $1 IN te
	printf           $29 origin $1
@2
	jneff            atmos_type $21 @4
	vdot             $15 origin IN
	negff            $15 $15
	clampf           tc $15 integstart te
	mulvvf           $1 IN tc
	addvvv           $1 origin $1
	length           minrad $1
	jmp              @5
@4
	movff            tc integstart
	movff            minrad $21
@5
	movff            t_1 tc
	ifltff           $17 t_1 te
	andltff          $17 minrad rbound
	cond_push        $17
	mulvvf           $1 IN t_1
	addvvv           PP origin $1
	jneff            atmos_type $21 @6
	negff            $12 falloff
	length           $8 PP
	subfff           $8 $8 $24
	mulfff           $15 $12 $8
	exp              $15 $15
	mulfff           dtau density $15
	jmp              @7
@6
	jneff            atmos_type $27 @8
	negff            $12 falloff
	zcomp            $8 PP
	mulfff           $15 $12 $8
	exp              $15 $15
	mulfff           dtau density $15
	jmp              @9
@8
	movff            dtau density
@9
@7
	randomf          $15
	subfff           $8 te t_1
	mulfff           $13 k dtau
	addfff           $13 $13 $28
	divfff           $13 $27 $13
	clampf           $13 $13 minstepsize maxstepsize
	minf             $8 $13 $8
	mulfff           ss $15 $8
	addfff           t_1 t_1 ss
	addfff           nsteps nsteps $27
@10
	ifleff           $17 t_1 te
	cjmpnot          $17 @11
	cond_push        $17
	movff            last_dtau dtau
	mulvvf           $1 IN t_1
	addvvv           PP origin $1
	jneff            atmos_type $21 @12
	negff            $12 falloff
	length           $8 PP
	subfff           $8 $8 $24
	mulfff           $15 $12 $8
	exp              $15 $15
	mulfff           dtau density $15
	jmp              @13
@12
	jneff            atmos_type $27 @14
	negff            $12 falloff
	zcomp            $8 PP
	mulfff           $15 $12 $8
	exp              $15 $15
	mulfff           dtau density $15
	jmp              @15
@14
	movff            dtau density
@15
@13
	mulfff           $15 $26 ss
	addfff           $8 dtau last_dtau
	mulfff           tau $15 $8
	negff            $15 tau
	exp              $15 $15
	negff            $8 tau
	mulfff           $8 $8 $33
	exp              $8 $8
	negff            $13 tau
	mulfff           $13 $13 $32
	exp              $13 $13
	movvf3           $1 $15 $8 $13
	movvf            $7 $27
	subvvv           dO $7 $1
	movvf            $7 $27
	subvvv           $6 $7 Ov
	maddvvv          Ov $6 dO
	subfff           $13 te t_1
	mulfff           $10 k dtau
	addfff           $10 $10 $28
	divfff           $10 $27 $10
	clampf           $10 $10 minstepsize maxstepsize
	minf             $13 $10 $13
	maxf             ss $13 $23
	addfff           t_1 t_1 ss
	addfff           nsteps nsteps $27
	cond_pop
	jmp              @10
@11
	cond_pop
	movff            t_1 tc
	ifgtff           $16 t_1 integstart
	andltff          $16 minrad rbound
	cond_push        $16
	mulvvf           $6 IN t_1
	addvvv           PP origin $6
	jneff            atmos_type $21 @16
	negff            $14 falloff
	length           $10 PP
	subfff           $10 $10 $24
	mulfff           $13 $14 $10
	exp              $13 $13
	mulfff           dtau density $13
	jmp              @17
@16
	jneff            atmos_type $27 @18
	negff            $14 falloff
	zcomp            $10 PP
	mulfff           $13 $14 $10
	exp              $13 $13
	mulfff           dtau density $13
	jmp              @19
@18
	movff            dtau density
@19
@17
	randomf          $13
	subfff           $10 t_1 integstart
	mulfff           $11 k dtau
	addfff           $11 $11 $28
	divfff           $11 $27 $11
	clampf           $11 $11 minstepsize maxstepsize
	minf             $10 $11 $10
	mulfff           ss $13 $10
	subfff           t_1 t_1 ss
	addfff           nsteps nsteps $27
@20
	ifgeff           $16 t_1 integstart
	cjmpnot          $16 @21
	cond_push        $16
	movff            last_dtau dtau
	mulvvf           $6 IN t_1
	addvvv           PP origin $6
	jneff            atmos_type $21 @22
	negff            $14 falloff
	length           $10 PP
	subfff           $10 $10 $24
	mulfff           $13 $14 $10
	exp              $13 $13
	mulfff           dtau density $13
	jmp              @23
@22
	jneff            atmos_type $27 @24
	negff            $14 falloff
	zcomp            $10 PP
	mulfff           $13 $14 $10
	exp              $13 $13
	mulfff           dtau density $13
	jmp              @25
@24
	movff            dtau density
@25
@23
	mulfff           $13 $26 ss
	addfff           $10 dtau last_dtau
	mulfff           tau $13 $10
	negff            $13 tau
	exp              $13 $13
	negff            $10 tau
	mulfff           $10 $10 $33
	exp              $10 $10
	negff            $11 tau
	mulfff           $11 $11 $32
	exp              $11 $11
	movvf3           $6 $13 $10 $11
	movvf            $3 $27
	subvvv           dO $3 $6
	movvf            $3 $27
	subvvv           $4 $3 dO
	mulvvv           $4 $4 Ov
	addvvv           Ov dO $4
	subfff           $11 t_1 integstart
	mulfff           $9 k dtau
	addfff           $9 $9 $28
	divfff           $9 $27 $9
	clampf           $9 $9 minstepsize maxstepsize
	minf             $11 $9 $11
	maxf             ss $11 $23
	subfff           t_1 t_1 ss
	addfff           nsteps nsteps $27
	cond_pop
	jmp              @20
@21
	cond_pop
	mulvvf           $2 lightcolor intensity
	movvf            $19 $27
	subvvv           $18 $19 Ov
	mulvvv           Cl $2 $18
	end_solar
	jleff            debug $21 @26
	printf           $31 nsteps tc integstart te Ov
@26
	return
