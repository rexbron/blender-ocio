# original source:
#light shadowspot( float intensity = 1;
#                  color lightcolor = 1;
#                  point from = point "shader" (0,0,0);
#                  point to = point "shader" (0,0,1);
#                  float coneangle = radians(30);
#                  float conedeltaangle = radians(5);
#                  float beamdistribution = 2;
#                  string shadowname = "";
#                  float samples = 16;
#                  float blur = 0.01;
#                  float bias = 0.01; )
#{
#    uniform vector A = normalize(to - from);
#    uniform float cosoutside = cos(coneangle);
#    uniform float cosinside = cos(coneangle - conedeltaangle);
#    illuminate (from, A, coneangle) {
#      float cosangle = (L . A) / length(L);
#      float atten = pow (cosangle, beamdistribution) / (L . L);
#      atten *= smoothstep (cosoutside, cosinside, cosangle);
#      if (shadowname != "")
#        atten *= 1 - shadow(shadowname, Ps, "samples", samples, "blur", blur, "bias", bias);
#      Cl = atten * intensity * lightcolor;
#    }
#}
light shadowspot
param uniform float intensity 1
param uniform color lightcolor 1 1 1
param uniform point from 0 0 0
param uniform point to 0 0 1
param uniform float coneangle 30
param uniform float conedeltaangle 5
param uniform float beamdistribution 2
param string shadowname ""
param uniform float samples 16
param uniform float blur 0.01
param uniform float bias 0.01
temp uniform vector A
temp uniform float cosoutside
temp uniform float cosinside
temp float cosangle
temp float atten
temp float $1
temp float $2
const string $3 "shader"
const string $4 ""
temp float $5
const string $6 "samples"
const string $7 "blur"
const string $8 "bias"
global L Cl Ps
codesegment @1
	ptocurr     from $3 from
	ptocurr     to $3 to
	radians     coneangle coneangle
	radians     conedeltaangle conedeltaangle
@1
	subvvv      A to from
	normalize   A A
	cos         cosoutside coneangle
	subfff      cosinside coneangle conedeltaangle
	cos         cosinside cosinside
	illuminate2 from A coneangle
	vdot        $1 L A
	length      $2 L
	divfff      cosangle $1 $2
	pow         $1 cosangle beamdistribution
	vdot        $2 L L
	divfff      atten $1 $2
	smoothstep  $1 cosoutside cosinside cosangle
	mulfff      atten atten $1
	jeqss       shadowname $4 @2
	shadow      $5 shadowname Ps $6 samples $7 blur $8 bias
	subfff      $5 1 $5
	mulfff      atten atten $5
@2
	mulvvf      Cl lightcolor intensity
	mulvvf      Cl Cl atten
	end_illuminate
	return
